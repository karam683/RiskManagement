"use strict";
const ruleFactory_1 = require("../ruleFactory");
function suggestSQLCast(m) {
    const results = [];
    const view = (d) => d.query;
    const check = (m) => m.foreach(view, (v) => {
        if (v.query.SET)
            for (const { SELECT } of v.query.SET.args) {
                for (const each of SELECT.columns || []) {
                    const { xpr, cast, $location: loc } = each;
                    if (cast && xpr) {
                        if (xpr[0].xpr && xpr[0].xpr && xpr[0].cast) {
                            continue;
                        }
                        else {
                            results.push({ message: `Potential issue: Missing SQL cast for column expression?`, loc, file: loc.file });
                        }
                    }
                }
            }
    });
    check(m);
    return results;
}
module.exports = ruleFactory_1.createRule({
    type: 'problem',
    docs: {
        description: `Should make suggestions for possible missing sql casts.`,
        category: 'Model Validation',
        version: '1.0.8'
    },
    fixable: 'code'
}, (cds, context) => {
    let report = [];
    const filepath = context.getFilename();
    if (filepath.endsWith('.cds')) {
        const m = cds.linked(cds.model);
        if (m) {
            report = suggestSQLCast(m);
        }
    }
    return report;
});
//# sourceMappingURL=sql-cast-suggestion.js.map